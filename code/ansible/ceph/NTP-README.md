Настройка NTP
=============

Описание
--------

Плейбук предназначен для настройки NTP. Поддерживается как обычная настройка с одним сервером времени. Так и более сложные и многоуровневые варианты с перекрёстным опросом группы узлов, для соблюдения единого времени в случае отказа внешних источников.

Структура
---------

Плейбук инсталирован в каталог `/root/hvs-ansible` и имеет следующую структуру:

    group_vars/
        ntp.yaml
    roles/
        hvs_ntp/
            defaults/
                main.yaml
            files/
                validate_conf.sh
            tasks/
                main.yaml
            templates/
                ntp.conf.j2
    ansible.cfg
    hosts.yaml
    ntp.yaml

Каталог `roles` содержит hvs_ntp описывающую логику настройки NTP на отдельном узле.

Файл `ntp.yaml`, является текстом плейбука и его точкой входа.

Файл `ansible.cfg` содержит конфигурационную информацию для ansible.

Перечисленные далее составные части являются структурами управляющими поведением, и подлежат кастомизации.

Каталог `group_vars` должен содержать файлы с переменными плейбука, определяющими поведение. Изначально содержит пример настройки.

Файл `hosts.yaml` -- инвентори, перечисление узлов организованных в группы.

Настройки
---------

> Плейбук применяется к хостам внесённым в группу **`ntp`**

Для кажтого узла применяется роль hvs_ntp. Параметры роли могут быть указаны сразу для всех узлов входящих в группу ntp или любым другим способом по разному в разных подгруппах, индивидуально для некоторых узлов (всё в соответствии с принципами составления инвентори в Ansible). Вот пример содержимого `group_vars/ntp.yaml`:

    hvs_ntp_enabled: true

    #hvs_ntp_upstreams: []
    #hvs_ntp_pools: []

    hvs_ntp_peers:
      - 192.168.213.208
      - 192.168.213.209
      - 192.168.213.210
    
    hvs_ntp_nics:
    - sys0

Здесь `hvs_ntp_enabled` отвечают за включение/выключение службы NTP на узле.

Параметры `hvs_ntp_upstreams`, `hvs_ntp_pools` и `hvs_ntp_peers` являются списками (пустыми по умолчанию) и конфигурируют службу NTP в соответсвующем ключе:

- `hvs_ntp_upstreams` - создаёт одностороннюю клиентскую связь с указанным сервером
- `hvs_ntp_pools` - создаёт одностороннюю клиентскую связь с указанным сервером или reference clock
- `hvs_ntp_peers` - создаёт симметричную одноранговую связь с удалённым узлом

Параметр `hvs_ntp_nics` должен содержать список сетевых интерфейсов которые будет слушать NTP демон хоста (по умолчанию только интерфейс `sys0`)

После внесения изменений следует сделать текущим каталог с плейбуком (`/root/hvs-ansible`) и запустить плейбук следующей командой:

    ansible-playbook ntp.yaml

> Хорошего вам дня
